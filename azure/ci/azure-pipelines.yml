trigger:
  branches:
    include:
      - main
  paths:
    include:
      - ci
      - iac
      - src

pool:
  vmImage: ubuntu-latest

variables:
  - template: templates/variables.yml

stages:
  - template: templates/build.yml
    parameters:
      environments:
        - tst
        - stg
        - prod

  - template: templates/release.yml
    parameters:
      environment: tst
      dependsOn: build
      condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))

  - template: templates/release.yml
    parameters:
      environment: stg
      dependsOn: tst
      condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'), eq(variables['Build.SourceBranch'], 'refs/heads/main'))

  - template: templates/release.yml
    parameters:
      environment: prod
      dependsOn: stg
      condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
