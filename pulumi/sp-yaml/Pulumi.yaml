name: sp-yaml
runtime: yaml

configuration:
  name:
    type: String
  api:
    type: String
  permission:
    type: String
  roleId:
    type: String
  secretName:
    type: String
  secretExpiration:
    type: String
    default: 8760h
  secretRotate:
    type: string
  audiences:
    type: List<String>
  issuer:
    type: String
  repo:
    type: String

variables:
  user:
    Fn::Invoke:
      Function: azuread:getClientConfig

  subscription:
    Fn::Invoke:
      Function: azure-native:authorization:getClientConfig

  roleDefinition:
    Fn::Invoke:
      Function: azure-native:authorization:getRoleDefinition
      Arguments:
        roleDefinitionId: ${roleId}
        scope: /subscriptions/${subscription.subscriptionId}

resources:
  app:
    type: azuread:Application
    properties:
      displayName: ${name}
      owners:
        - ${user.objectId}
      requiredResourceAccesses:
        - resourceAppId: ${api}
          resourceAccesses:
            - id: ${permission}
              type: Role

  sp:
    type: azuread:ServicePrincipal
    properties:
      applicationId: ${app.applicationId}
      owners:
        - ${user.objectId}

  role:
    type: azure-native:authorization:RoleAssignment
    properties:
      principalId: ${sp.objectId}
      principalType: ServicePrincipal
      roleDefinitionId: ${roleDefinition.id}
      scope: /subscriptions/${subscription.subscriptionId}

  secret:
    type: azuread:ApplicationPassword
    properties:
      displayName: ${secretName}
      applicationObjectId: ${app.objectId}
      endDateRelative: ${secretExpiration}
      rotateWhenChanged:
        rotation: ${secretRotate}

  main:
    type: azuread:ApplicationFederatedIdentityCredential
    properties:
      displayName: main
      applicationObjectId: ${app.objectId}
      audiences: ${audiences}
      issuer: ${issuer}
      subject: repo:${repo}:ref:refs/heads/main

  pull_request:
    type: azuread:ApplicationFederatedIdentityCredential
    properties:
      displayName: pull_request
      applicationObjectId: ${app.objectId}
      audiences: ${audiences}
      issuer: ${issuer}
      subject: repo:${repo}:pull_request

  dev:
    type: azuread:ApplicationFederatedIdentityCredential
    properties:
      displayName: dev
      applicationObjectId: ${app.objectId}
      audiences: ${audiences}
      issuer: ${issuer}
      subject: repo:${repo}:environment:dev

  command:
    type: command:local:Command
    properties:
      create: |
        uri="https://graph.microsoft.com/v1.0/servicePrincipals/${sp.objectId}/appRoleAssignments"
        resourceId=$(az ad sp show --id ${api} --query id --output tsv)
        az rest --method POST --uri $uri --body "{\"principalId\": \"${sp.objectId}\",\"resourceId\": \"$resourceId\",\"appRoleId\": \"${permission}\"}"

outputs:
  tenantId: ${user.tenantId}
  clientId: ${app.applicationId}
  clientSecret: ${secret.value}
